DPCalendar=window.DPCalendar||{},function(a,o,i){"use strict";function r(){var t=a.querySelector(".com-dpcalendar-eventform__overlapping");if(t){t.style.display="none";var e=new Url;i.request("task=event.overlapping",function(e){e.data.message&&(t.style.display="block",t.className="com-dpcalendar-eventform__overlapping dp-info-box"+(e.data.count?"":" dp-info-box_success"),t.innerHTML=e.data.message,t.getAttribute("data-overlapping")&&(a.querySelector(".dp-button-apply").disabled=0<e.data.count,a.querySelector(".dp-button-save").disabled=0<e.data.count,a.querySelector(".dp-button-save2new").disabled=0<e.data.count,a.querySelector(".dp-button-save2copy").disabled=0<e.data.count))},i.formToQueryString(a.querySelector(".com-dpcalendar-eventform__form"),"input:not([name=task]), select")+(e.query.e_id?"&id="+e.query.e_id:""))}}function c(){if(a.getElementById("jform_scheduling")){var e=a.getElementById("jform_rrule").value;if(e){var d=null;e.split(";").forEach(function(e){var t=e.split("=");if(0!==t.length)switch(t[0]){case"FREQ":[].slice.call(a.getElementById("jform_scheduling").querySelectorAll("input")).forEach(function(e){e.checked=e.value==t[1],e.value==t[1]&&(d=e.value),"DAILY"==t[1]&&(a.getElementById("jform_scheduling_daily_weekdays0").checked=!1,a.getElementById("jform_scheduling_daily_weekdays1").checked=!0)});break;case"BYDAY":"WEEKLY"==d&&"MO,TU,WE,TH,FR"==t[1]&&(a.getElementById("jform_scheduling_daily_weekdays0").checked=!0,a.getElementById("jform_scheduling_daily_weekdays1").checked=!1,a.getElementById("jform_scheduling1").checked=!0),t[1].split(",").forEach(function(e){if("MONTHLY"==d){var t=e.length,l=e.substring(t-2,t),n=e.substring(0,t-2);-1==n&&(n="last"),a.getElementById("jform_scheduling_monthly_week").querySelector('option[value="'+n+'"]').selected=!0,a.getElementById("jform_scheduling_monthly_week_days").querySelector('option[value="'+l+'"]').selected=!0}else a.getElementById("jform_scheduling_weekly_days").querySelector('option[value="'+e+'"]').selected=!0});break;case"BYMONTHDAY":a.getElementById("jform_scheduling_monthly_options").querySelector('input[value="by_day"]').checked=!0,t[1].split(",").forEach(function(e){a.getElementById("jform_scheduling_monthly_days").querySelector('option[value="'+e+'"]').selected=!0});break;case"COUNT":a.getElementById("jform_scheduling_repeat_count").value=t[1];break;case"INTERVAL":a.getElementById("jform_scheduling_interval").value=t[1];break;case"UNTIL":var l=a.getElementById("jform_scheduling_end_date");l.value=moment.utc(t[1]).format(l.getAttribute("format")),l.setAttribute("data-date",t[1].substr(0,8))}}),u()}else u()}else u()}function s(){if(a.getElementById("jform_scheduling")){var e,n="";if(a.getElementById("jform_scheduling1").checked&&(n="FREQ=DAILY",a.getElementById("jform_scheduling_daily_weekdays0").checked&&(n="FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR")),a.getElementById("jform_scheduling2").checked)n="FREQ=WEEKLY",0<(e=[].slice.call(a.querySelectorAll("#jform_scheduling_weekly_days option:checked"))).length&&(n+=";BYDAY=",e.forEach(function(e){n+=e.value+","}),n=n.slice(0,-1));if(a.getElementById("jform_scheduling3").checked)if(n="FREQ=MONTHLY",a.getElementById("jform_scheduling_monthly_options0").checked)0<(e=[].slice.call(a.querySelectorAll("#jform_scheduling_monthly_days option:checked"))).length&&(n+=";BYMONTHDAY=",e.forEach(function(e){n+=e.value+","}),n=n.slice(0,-1));else 0<(e=[].slice.call(a.querySelectorAll("#jform_scheduling_monthly_week option:checked"))).length&&(n+=";BYDAY=",e.forEach(function(e){var t=[].slice.call(a.querySelectorAll("#jform_scheduling_monthly_week_days option:checked"));if(0!=t.length){var l=e.value;"last"==l&&(l=-1),t.forEach(function(e){n+=l+e.value+","})}}),n.endsWith(",")&&(n=n.slice(0,-1)));if(a.getElementById("jform_scheduling4").checked&&(n="FREQ=YEARLY"),1<n.length){var t=a.getElementById("jform_scheduling_interval").value;0<t&&(n+=";INTERVAL="+t);var l=a.getElementById("jform_scheduling_repeat_count").value;0<l&&(n+=";COUNT="+l);var d=a.getElementById("jform_scheduling_end_date"),o=moment(d.value,d.getAttribute("data-format"));o.isValid()&&(n+=";UNTIL="+o.format("YYYYMMDD")+"T235900Z")}a.getElementById("jform_rrule").value=n}}function y(){var n=a.querySelector(".com-dpcalendar-eventform__location .dp-map");null!=n&&null!=n.dpmap&&(n.dpmap.invalidateSize&&n.dpmap.invalidateSize(),i.Map.clearMarkers(n),[].slice.call(a.querySelectorAll("#jform_location_ids option:checked")).forEach(function(e){var t=e.innerHTML,l=t.substring(t.lastIndexOf("[")+1,t.lastIndexOf("]")).split(":");l.length<2||0==l[0]&&0==l[1]||i.Map.createMarker(n,{latitude:l[0],longitude:l[1],title:t})}))}function u(){if(!a.getElementById("jform_scheduling"))return a.querySelector(".dp-field-scheduling-end-date").style.display="none",a.querySelector(".dp-field-scheduling-interval").style.display="none",a.querySelector(".dp-field-scheduling-repeat-count").style.display="none",a.querySelector(".dp-field-rrule").style.display="none",a.querySelector(".dp-field-scheduling-daily-weekdays").style.display="none",a.querySelector(".dp-field-scheduling-weekly-days").style.display="none",a.querySelector(".dp-field-scheduling-monthly-options").style.display="none",a.querySelector(".dp-field-scheduling-monthly-week").style.display="none",a.querySelector(".dp-field-scheduling-monthly-week-days").style.display="none",void(a.querySelector(".dp-field-scheduling-monthly-days").style.display="none");a.getElementById("jform_scheduling0").checked?(a.querySelector(".dp-field-scheduling-end-date").style.display="none",a.querySelector(".dp-field-scheduling-interval").style.display="none",a.querySelector(".dp-field-scheduling-repeat-count").style.display="none",a.querySelector(".dp-field-rrule").style.display="none"):(a.querySelector(".dp-field-scheduling-end-date").style.display="block",a.querySelector(".dp-field-scheduling-interval").style.display="block",a.querySelector(".dp-field-scheduling-repeat-count").style.display="block",a.querySelector(".dp-field-rrule").style.display="block"),a.getElementById("jform_scheduling1").checked?a.querySelector(".dp-field-scheduling-daily-weekdays").style.display="block":a.querySelector(".dp-field-scheduling-daily-weekdays").style.display="none",a.getElementById("jform_scheduling2").checked?a.querySelector(".dp-field-scheduling-weekly-days").style.display="block":a.querySelector(".dp-field-scheduling-weekly-days").style.display="none",a.getElementById("jform_scheduling3").checked?(a.querySelector(".dp-field-scheduling-monthly-options").style.display="block",a.querySelector(".dp-field-scheduling-monthly-week").style.display="block",a.querySelector(".dp-field-scheduling-monthly-week-days").style.display="block",a.querySelector(".dp-field-scheduling-monthly-days").style.display="block",a.getElementById("jform_scheduling_monthly_options0").checked?(a.querySelector(".dp-field-scheduling-monthly-week").style.display="none",a.querySelector(".dp-field-scheduling-monthly-week-days").style.display="none",a.querySelector(".dp-field-scheduling-monthly-days").style.display="block"):(a.querySelector(".dp-field-scheduling-monthly-week").style.display="block",a.querySelector(".dp-field-scheduling-monthly-week-days").style.display="block",a.querySelector(".dp-field-scheduling-monthly-days").style.display="none")):(a.querySelector(".dp-field-scheduling-monthly-options").style.display="none",a.querySelector(".dp-field-scheduling-monthly-week").style.display="none",a.querySelector(".dp-field-scheduling-monthly-week-days").style.display="none",a.querySelector(".dp-field-scheduling-monthly-days").style.display="none")}a.addEventListener("DOMContentLoaded",function(){var e=a.getElementById("jform_rrule");if(e&&(e.addEventListener("change",function(){c()}),[].slice.call(a.querySelectorAll(".dp-field-scheduling,#jform_scheduling_monthly_options,#jform_scheduling_daily_weekdays")).forEach(function(e){e.addEventListener("click",function(){u(),s()})}),[].slice.call(a.querySelectorAll("#jform_scheduling_end_date, #jform_scheduling_interval, #jform_scheduling_repeat_count,#jform_scheduling_weekly_days, #jform_scheduling_monthly_days, #jform_scheduling_monthly_week_days, #jform_scheduling_monthly_week")).forEach(function(e){e.addEventListener("change",function(){s()})}),c()),[].slice.call(a.querySelectorAll("#jform_all_day input")).forEach(function(e){e.addEventListener("click",function(){0==this.value?(a.getElementById("jform_start_date_time").style.display="inline-block",a.getElementById("jform_end_date_time").style.display="inline-block"):(a.getElementById("jform_start_date_time").style.display="none",a.getElementById("jform_end_date_time").style.display="none"),r()})}),a.getElementById("jform_all_day0").checked||!a.getElementById("jform_all_day0").checked&&!a.getElementById("jform_all_day1").checked?(a.getElementById("jform_start_date_time").style.display="inline-block",a.getElementById("jform_end_date_time").style.display="inline-block"):(a.getElementById("jform_start_date_time").style.display="none",a.getElementById("jform_end_date_time").style.display="none"),[].slice.call(a.querySelectorAll("#jform_start_date, #jform_start_date_time, #jform_end_date, #jform_end_date_time, #jform_rooms")).forEach(function(e){e.addEventListener("change",function(){setTimeout(r,2e3)})}),a.getElementById("jform_catid").addEventListener("change",function(e){for(var t=0;t<e.target.length;t++)if(e.target.value&&isNaN(parseInt(e.target.options[t].value)))return o.loadingLayer("show"),o.submitbutton("event.reload"),!0;setTimeout(r,2e3)}),setTimeout(r,2e3),setTimeout(y,2e3),o.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")&&[].slice.call(a.querySelectorAll(".dp-field-scheduling .controls, .dp-tabs__tab-booking .controls")).forEach(function(e){var t=a.createElement("span");t.className="dp-free-information-text",t.innerText=o.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS"),e.appendChild(t)}),[].slice.call(a.querySelectorAll(".com-dpcalendar-eventform__actions .dp-button")).forEach(function(e){e.addEventListener("click",function(){o.submitbutton("event."+this.getAttribute("data-task"))})}),o.submitbutton=function(e){var t=a.getElementsByName("adminForm")[0];if(t&&(-1<e.indexOf("reload")||-1<e.indexOf("cancel")||-1<e.indexOf("delete")||a.formvalidator.isValid(t))){var l=o.JText._("COM_DPCALENDAR_VIEW_EVENT_SEND_TICKET_HOLDERS_NOFICATION");l&&(-1<e.indexOf("save")||-1<e.indexOf("apply"))&&confirm(l)&&(a.getElementById("jform_notify_changes").value=1),o.submitform(e,t)}},[].slice.call(a.querySelectorAll(".com-dpcalendar-eventform select:not(#jform_tags):not(#jform_tags)")).forEach(function(e){e._choicejs=new Choices(e,{itemSelectText:"",noChoicesText:"",shouldSortItems:!1,shouldSort:!1,removeItemButton:"jform_catid"!=e.id})}),0==parseInt(a.getElementById("jform_id").value)){var t=a.getElementById("jform_title");i.autocomplete.create(t),t.addEventListener("dp-autocomplete-select",function(e){a.querySelector("input[name=template_event_id]").value=e.detail.value,o.submitbutton("event.reloadfromevent")});var l=new Url;t.addEventListener("dp-autocomplete-change",function(){i.request("task=event.similar",function(e){i.autocomplete.setItems(t,e.data)},i.formToQueryString(a.querySelector(".com-dpcalendar-eventform__form"),"input:not([name=task]), select")+"&id="+l.query.e_id)})}if(a.querySelector(".com-dpcalendar-eventform__location")){a.getElementById("jform_location_ids").addEventListener("change",function(){if(!a.getElementById("jform_rooms"))return!0;o.loadingLayer("show"),o.submitbutton("event.reload")}),a.querySelector(".com-dpcalendar-eventform__location-form .dp-button-cancel").addEventListener("click",function(){var e=a.createEvent("CustomEvent");e.initCustomEvent("click"),a.querySelector(".com-dpcalendar-eventform__toggle").dispatchEvent(e)}),a.querySelector(".com-dpcalendar-eventform__location-form .dp-button-save").addEventListener("click",function(){function e(e,t){var l=a.getElementById("location_"+t);l&&(e.jform[t]=l.value)}var t=[];t.jform=[],e(t,"title"),e(t,"country"),e(t,"province"),e(t,"city"),e(t,"zip"),e(t,"street"),e(t,"number"),t.jform.state=1,t.jform.language="*",t[a.querySelector('[name="location_token"]').value]="1",t.ajax="1",t.id=0,i.request("task=locationform.save",function(e){null!=e.data.id&&null!=e.data.display&&(a.getElementById("jform_location_ids")._choicejs.setChoices([{value:e.data.id,label:e.data.display,selected:!0}],"value","label"),y(),[].slice.call(a.querySelectorAll(".com-dpcalendar-eventform__location-form input")).forEach(function(e){e.value=""}))},i.arrayToQueryString(t))});var n=a.querySelector(".com-dpcalendar-eventform__toggle");n&&n.addEventListener("click",function(){i.slideToggle(a.querySelector(".com-dpcalendar-eventform__location-form"),function(e){var t=a.querySelector(".com-dpcalendar-eventform__toggle");e?(t.querySelector('[data-direction="up"]').style.display="inline",t.querySelector('[data-direction="down"]').style.display="none"):(t.querySelector('[data-direction="up"]').style.display="none",t.querySelector('[data-direction="down"]').style.display="inline")})}),[].slice.call(a.querySelectorAll(".com-dpcalendar-eventform__location-form input")).forEach(function(e){e.classList.add("novalidate")});var d=a.querySelector(".com-dpcalendar-eventform .dp-field-rooms");d&&0==d.querySelectorAll(".choices__item[data-value]").length&&(d.style.display="none")}})}(document,Joomla,DPCalendar);
