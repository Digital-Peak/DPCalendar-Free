DPCalendar=window.DPCalendar||{},function(r,c,i){"use strict";function s(){var t=r.querySelector(".com-dpcalendar-eventform__overlapping");if(t){t.style.display="none";var e=new Url;i.request("task=event.overlapping",function(e){e.data.message&&(t.style.display="block",t.className="com-dpcalendar-eventform__overlapping dp-info-box"+(e.data.count?"":" dp-info-box_success"),t.innerHTML=e.data.message,t.getAttribute("data-overlapping")&&(r.querySelector(".dp-button-apply").disabled=0<e.data.count,r.querySelector(".dp-button-save").disabled=0<e.data.count,r.querySelector(".dp-button-save2new").disabled=0<e.data.count,r.querySelector(".dp-button-save2copy").disabled=0<e.data.count))},i.formToQueryString(r.querySelector(".com-dpcalendar-eventform__form"),"input:not([name=task]), select")+(e.query.e_id?"&id="+e.query.e_id:""))}}function u(){if(r.getElementById("jform_scheduling")){var e=r.getElementById("jform_rrule").value;if(e){var n=null;e.split(";").forEach(function(e){var t=e.split("=");if(0!==t.length)switch(t[0]){case"FREQ":[].slice.call(r.getElementById("jform_scheduling").querySelectorAll("input")).forEach(function(e){e.checked=e.value==t[1],e.value==t[1]&&(n=e.value),"DAILY"==t[1]&&(r.getElementById("jform_scheduling_daily_weekdays0").checked=!1,r.getElementById("jform_scheduling_daily_weekdays1").checked=!0)});break;case"BYDAY":"WEEKLY"==n&&"MO,TU,WE,TH,FR"==t[1]&&(r.getElementById("jform_scheduling_daily_weekdays0").checked=!0,r.getElementById("jform_scheduling_daily_weekdays1").checked=!1,r.getElementById("jform_scheduling1").checked=!0),t[1].split(",").forEach(function(e){if("MONTHLY"==n){var t=e.length,l=e.substring(t-2,t),d=e.substring(0,t-2);-1==d&&(d="last"),d&&(r.getElementById("jform_scheduling_monthly_week").querySelector('option[value="'+d+'"]').selected=!0),l&&(r.getElementById("jform_scheduling_monthly_week_days").querySelector('option[value="'+l+'"]').selected=!0)}else r.getElementById("jform_scheduling_weekly_days").querySelector('option[value="'+e+'"]').selected=!0});break;case"BYMONTHDAY":r.getElementById("jform_scheduling_monthly_options").querySelector('input[value="by_day"]').checked=!0,t[1].split(",").forEach(function(e){r.getElementById("jform_scheduling_monthly_days").querySelector('option[value="'+e+'"]').selected=!0});break;case"COUNT":r.getElementById("jform_scheduling_repeat_count").value=t[1];break;case"INTERVAL":r.getElementById("jform_scheduling_interval").value=t[1];break;case"UNTIL":var l=r.getElementById("jform_scheduling_end_date");l.value=moment.utc(t[1]).format(l.getAttribute("format")),l.setAttribute("data-date",t[1].substr(0,8))}}),f()}else f()}else f()}function m(){if(r.getElementById("jform_scheduling")){var e,d="";if(r.getElementById("jform_scheduling1").checked&&(d="FREQ=DAILY",r.getElementById("jform_scheduling_daily_weekdays0").checked&&(d="FREQ=WEEKLY;BYDAY=MO,TU,WE,TH,FR")),r.getElementById("jform_scheduling2").checked)d="FREQ=WEEKLY",0<(e=[].slice.call(r.querySelectorAll("#jform_scheduling_weekly_days option:checked"))).length&&(d+=";BYDAY=",e.forEach(function(e){d+=e.value+","}),d=d.slice(0,-1));if(r.getElementById("jform_scheduling3").checked)if(d="FREQ=MONTHLY",r.getElementById("jform_scheduling_monthly_options0").checked)0<(e=[].slice.call(r.querySelectorAll("#jform_scheduling_monthly_days option:checked"))).length&&(d+=";BYMONTHDAY=",e.forEach(function(e){d+=e.value+","}),d=d.slice(0,-1));else 0<(e=[].slice.call(r.querySelectorAll("#jform_scheduling_monthly_week option:checked"))).length&&(d+=";BYDAY=",e.forEach(function(e){var t=[].slice.call(r.querySelectorAll("#jform_scheduling_monthly_week_days option:checked"));if(0!=t.length){var l=e.value;"last"==l&&(l=-1),t.forEach(function(e){d+=l+e.value+","})}}),d.endsWith(",")&&(d=d.slice(0,-1)));if(r.getElementById("jform_scheduling4").checked&&(d="FREQ=YEARLY"),1<d.length){var t=r.getElementById("jform_scheduling_interval").value;0<t&&(d+=";INTERVAL="+t);var l=r.getElementById("jform_scheduling_repeat_count").value;0<l&&(d+=";COUNT="+l);var n=r.getElementById("jform_scheduling_end_date"),o=moment(n.value,n.getAttribute("data-format"));o.isValid()&&(d+=";UNTIL="+o.format("YYYYMMDD")+"T235900Z")}r.getElementById("jform_rrule").value=d}}function _(){var d=r.querySelector(".com-dpcalendar-eventform .dp-map");null!=d&&null!=d.dpmap&&(d.dpmap.invalidateSize&&d.dpmap.invalidateSize(),i.Map.clearMarkers(d),[].slice.call(r.querySelectorAll("#jform_location_ids option:checked")).forEach(function(e){var t=e.innerHTML,l=t.substring(t.lastIndexOf("[")+1,t.lastIndexOf("]")).split(":");l.length<2||0==l[0]&&0==l[1]||i.Map.createMarker(d,{latitude:l[0],longitude:l[1],title:t})}))}function f(){r.querySelector(".dp-field-scheduling-end-date").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-interval").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-repeat-count").classList.add("dp-control_hidden"),r.querySelector(".dp-field-rrule").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-daily-weekdays").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-weekly-days").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-monthly-options").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-monthly-week").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-monthly-week-days").classList.add("dp-control_hidden"),r.querySelector(".dp-field-scheduling-monthly-days").classList.add("dp-control_hidden"),r.getElementById("jform_scheduling")&&(r.getElementById("jform_scheduling0").checked||(r.querySelector(".dp-field-scheduling-end-date").classList.remove("dp-control_hidden"),r.querySelector(".dp-field-scheduling-interval").classList.remove("dp-control_hidden"),r.querySelector(".dp-field-scheduling-repeat-count").classList.remove("dp-control_hidden"),r.querySelector(".dp-field-rrule").classList.remove("dp-control_hidden"),r.getElementById("jform_scheduling1").checked&&r.querySelector(".dp-field-scheduling-daily-weekdays").classList.remove("dp-control_hidden"),r.getElementById("jform_scheduling2").checked&&r.querySelector(".dp-field-scheduling-weekly-days").classList.remove("dp-control_hidden"),r.getElementById("jform_scheduling3").checked&&(r.querySelector(".dp-field-scheduling-monthly-options").classList.remove("dp-control_hidden"),r.getElementById("jform_scheduling_monthly_options0").checked?r.querySelector(".dp-field-scheduling-monthly-days").classList.remove("dp-control_hidden"):(r.querySelector(".dp-field-scheduling-monthly-week").classList.remove("dp-control_hidden"),r.querySelector(".dp-field-scheduling-monthly-week-days").classList.remove("dp-control_hidden")))))}r.addEventListener("DOMContentLoaded",function(){var e=r.getElementById("jform_rrule");e&&(e.addEventListener("change",function(e){u()}),[].slice.call(r.querySelectorAll(".dp-field-scheduling,#jform_scheduling_monthly_options,#jform_scheduling_daily_weekdays")).forEach(function(e){e.addEventListener("click",function(e){f(),m()})}),[].slice.call(r.querySelectorAll("#jform_scheduling_end_date, #jform_scheduling_interval, #jform_scheduling_repeat_count,#jform_scheduling_weekly_days, #jform_scheduling_monthly_days, #jform_scheduling_monthly_week_days, #jform_scheduling_monthly_week")).forEach(function(e){e.addEventListener("change",function(e){m()})}),u()),[].slice.call(r.querySelectorAll("#jform_all_day input")).forEach(function(e){e.addEventListener("click",function(e){0==this.value?(r.getElementById("jform_start_date_time").style.display="inline-block",r.getElementById("jform_end_date_time").style.display="inline-block"):(r.getElementById("jform_start_date_time").style.display="none",r.getElementById("jform_end_date_time").style.display="none"),s()})}),r.getElementById("jform_all_day0").checked||!r.getElementById("jform_all_day0").checked&&!r.getElementById("jform_all_day1").checked?(r.getElementById("jform_start_date_time").style.display="inline-block",r.getElementById("jform_end_date_time").style.display="inline-block"):(r.getElementById("jform_start_date_time").style.display="none",r.getElementById("jform_end_date_time").style.display="none"),[].slice.call(r.querySelectorAll("#jform_start_date, #jform_start_date_time, #jform_end_date, #jform_end_date_time, #jform_rooms")).forEach(function(e){e.addEventListener("change",function(e){setTimeout(s,2e3)})}),r.getElementById("jform_catid").addEventListener("change",function(e){for(var t=0;t<e.target.length;t++)if(e.target.value&&isNaN(parseInt(e.target.options[t].value))){var l=r.querySelector(".dp-loader");return l&&l.classList.remove("dp-loader_hidden"),c.submitbutton("event.reload"),!0}setTimeout(s,2e3)}),setTimeout(s,2e3);var t=r.querySelector(".com-dpcalendar-eventform .dp-map");if(null!=t&&(t.addEventListener("dp-map-loaded",function(){_()}),t.dpmap&&_()),c.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS")&&[].slice.call(r.querySelectorAll(".dp-field-scheduling .controls, .dp-tabs__tab-booking .controls")).forEach(function(e){var t=r.createElement("span");t.className="dp-free-information-text",t.innerText=c.JText._("COM_DPCALENDAR_ONLY_AVAILABLE_SUBSCRIBERS"),e.appendChild(t)}),[].slice.call(r.querySelectorAll(".com-dpcalendar-eventform__actions .dp-button")).forEach(function(e){e.addEventListener("click",function(){c.submitbutton("event."+this.getAttribute("data-task"))})}),c.submitbutton=function(e){var t=r.getElementsByName("adminForm")[0];if(t&&(-1<e.indexOf("reload")||-1<e.indexOf("cancel")||-1<e.indexOf("delete")||r.formvalidator.isValid(t))){var l=c.JText._("COM_DPCALENDAR_VIEW_EVENT_SEND_TICKET_HOLDERS_NOFICATION");l&&(-1<e.indexOf("save")||-1<e.indexOf("apply"))&&confirm(l)&&(r.getElementById("jform_notify_changes").value=1);var d=r.querySelector(".dp-loader");d&&d.classList.remove("dp-loader_hidden"),c.submitform(e,t)}},[].slice.call(r.querySelectorAll(".com-dpcalendar-eventform select:not(#jform_color):not(#jform_tags)")).forEach(function(e){e._choicejs=new Choices(e,{itemSelectText:"",noChoicesText:"",shouldSortItems:!1,shouldSort:!1,removeItemButton:"jform_catid"!=e.id,searchResultLimit:30})}),0==parseInt(r.getElementById("jform_id").value)){var l=r.getElementById("jform_title");i.autocomplete.create(l),l.addEventListener("dp-autocomplete-select",function(e){r.querySelector("input[name=template_event_id]").value=e.detail.value,c.submitbutton("event.reloadfromevent")});var d=new Url;l.addEventListener("dp-autocomplete-change",function(e){i.request("task=event.similar",function(e){i.autocomplete.setItems(l,e.data)},i.formToQueryString(r.querySelector(".com-dpcalendar-eventform__form"),"input:not([name=task]), select")+"&id="+d.query.e_id)})}var n=r.querySelector(".dp-field-captcha");n&&r.querySelector(".com-dpcalendar-eventform__form").appendChild(n),r.getElementById("jform_location_ids").addEventListener("change",function(e){if(!r.getElementById("jform_rooms"))return!0;var t=r.querySelector(".dp-loader");t&&t.classList.remove("dp-loader_hidden"),c.submitbutton("event.reload")});var o=r.querySelector(".com-dpcalendar-eventform .dp-field-rooms");o&&0==o.querySelectorAll(".choices__item[data-value]").length&&(o.style.display="none");var a=r.querySelector(".com-dpcalendar-eventform #jform_location_lookup");i.autocomplete&&a&&(i.autocomplete.create(a),a.addEventListener("dp-autocomplete-select",function(e){i.request("task=locationform.save",function(e){if(null!=e.data.id&&null!=e.data.display){a.value="";var t=r.getElementById("jform_location_ids");-1==t._choicejs.getValue(!0).indexOf(e.data.id)&&(t._choicejs.setChoices([{value:e.data.id,label:e.data.display,selected:!0}],"value","label"),_())}},"lookup="+e.detail.value+"&lookup_title="+e.detail.title)}),a.addEventListener("dp-autocomplete-change",function(e){var t="location.searchloc";-1==window.location.href.indexOf("administrator")&&(t="locationform.searchloc"),i.request("task="+t+"&loc="+encodeURIComponent(e.target.value.trim()),function(e){i.autocomplete.setItems(a,e.data)})}))})}(document,Joomla,DPCalendar);